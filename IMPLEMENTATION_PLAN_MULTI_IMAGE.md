# 複数画像対応 実装計画書 (Image Color Analyzer)

## 1. 目的
現在の単一画像分析機能を拡張し、複数の画像を一度にアップロード・分析できる機能を追加する。また、類似度設定を一括で適用し、作業効率を向上させる。

## 2. 潜在的な課題と解決策

### A. サーバーレス環境 (Vercel) の制限
*   **課題**: 
    *   **リクエストサイズ制限**: 複数画像を一度にPOSTすると、Vercelの関数ペイロード制限（通常4.5MB）を容易に超過する。
    *   **タイムアウト**: 複数画像の処理をサーバー側で直列に行うと、実行時間制限（10〜60秒）に抵触するリスクがある。
*   **解決策**: 
    *   **バックエンド**: 既存の `/api/analyze`（1枚処理用）を変更せずそのまま利用する。
    *   **フロントエンド**: 画像配列をループさせ、**1枚ずつ個別にAPIリクエストを送信する**設計とする。これにより、ペイロード制限を回避し、並列処理による高速化も期待できる。

### B. UI/UX の考慮事項
*   **課題**: 多量の画像をリスト表示すると画面が縦長になりすぎる。
*   **解決策**: 
    *   **プレビュー**: 正方形にトリミングしたマトリックス（グリッド）表示を採用し、一覧性を確保する。
    *   **設定**: 類似度スライダーは「グローバル設定」として一箇所に配置し、全画像に適用する。

## 3. 実装フェーズ

### フェーズ 1: バックエンド (変更なし)
*   `server.js` の変更は不要。
*   現状の `upload.single('image')` はそのまま維持し、単一ファイル処理に専念させる。

### フェーズ 2: フロントエンド (HTML/JS) の改修

#### `public/index.html`
1.  **Input要素**: `<input type="file">` に `multiple` 属性を追加。
2.  **プレビューエリア**: 
    *   単一の `<img>` タグを廃止。
    *   代わりに `<div id="previewGrid">` コンテナを作成し、動的にサムネイルを追加できる構造にする。
3.  **UI文言**: 「画像をドラッグ＆ドロップ」などの文言を複数形に対応させる（日本語化済みであれば文脈に合わせる）。

#### `public/script.js`
1.  **状態管理**:
    *   `selectedFile` (単一) 変数を廃止し、`selectedFiles` (配列 `[]`) を導入。
    *   追加アップロードに対応するか、毎回置き換えるかを決定（今回はシンプルに「置き換え」からスタート推奨）。
2.  **プレビュー生成**:
    *   ファイル選択時にループ処理で `FileReader` を回し、サムネイル要素をグリッドに追加。
3.  **分析ロジック (重要)**:
    *   `analyzeBtn` クリック時、`selectedFiles` 配列に対してループ処理を実行。
    *   `Promise.all` を使用して並行リクエスト、または順次 `await` でリクエストを送信。
    *   各リクエストのレスポンスを受け取り次第、または全完了後に結果DOMを生成して追加。
    *   進捗状況（例: "分析中: 3/10..."）を表示するUIフィードバックを追加することを推奨。

### フェーズ 3: スタイリング (CSS)

#### `public/styles.css`
1.  **グリッドレイアウト**:
    ```css
    .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        width: 100%;
    }
    ```
2.  **正方形サムネイル**:
    ```css
    .preview-thumbnail {
        width: 100%;
        aspect-ratio: 1 / 1;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid var(--border);
    }
    ```

## 4. 今後の拡張性（オプション）
*   **個別削除機能**: プレビューグリッド内の各画像に「×」ボタンを付け、特定画像だけ除外する機能。
*   **一括CSVダウンロード**: 全画像の結果をまとめたZIPファイル、あるいはシートを分けたExcelファイルの生成機能。
